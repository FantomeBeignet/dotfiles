#+title Emacs config

* Cleaner folders config

** Keep custom vars out of config file

#+begin_src emacs-lisp
  (setq custom-file (locate-user-emacs-file "custom-vars.el"))
  (load custom-file 'noerror 'nomessage)
#+end_src

** Keep backup files in the same backup dir

#+begin_src emacs-lisp
  (setq backup-directory-alist '(("" . "~/.emacs.d/backups")))
#+end_src

** Keep undo tree files in a undos dir

#+begin_src emacs-lisp
  (setq undo-tree-history-directory-alist '(("." . "~/.emacs.d/undos")))
#+end_src

* Package setup

** Setup package.el to work with MELPA

#+begin_src emacs-lisp
  (require 'package)
  (add-to-list 'package-archives
	       '("melpa" . "https://melpa.org/packages/"))
  (package-initialize)
  (package-refresh-contents)
#+end_src

** use-package setup

#+begin_src emacs-lisp
  (unless (package-installed-p 'use-package)
    (package-install 'use-package))
  (require 'use-package)
  (setq use-package-always-ensure t)
#+end_src

* UI and style config

** Basic GUI settings

#+begin_src emacs-lisp
  (tool-bar-mode -1)
  (menu-bar-mode -1)
  (scroll-bar-mode -1)
#+end_src 

** Show relative line numbers in gutter

#+begin_src emacs-lisp
  (global-display-line-numbers-mode 1)
  (setq display-line-numbers-type 'relative)

  ;; Disable for certain modes
  (dolist (mode '(eshell-mode-hook
		  term-mode-hook))
    (add-hook mode (lambda() (display-line-numbers-mode 0))))
#+end_src

** Show column number in modeline

#+begin_src emacs-lisp
  (column-number-mode)
#+end_src

** Fonts

#+begin_src emacs-lisp
  (set-face-attribute 'default nil
		      :font "SauceCodePro Nerd Font 14"
		      :weight 'medium)
  (set-face-attribute 'fixed-pitch nil
		      :font "SauceCodePro Nerd Font 14"
		      :weight 'medium)
  (add-to-list 'default-frame-alist '(font . "SauceCodePro Nerd Font 14"))
#+end_src

** Theme (palenight from doom-themes)

#+begin_src emacs-lisp
  (use-package doom-themes
    :config
    ;; Global settings (defaults)
    (setq doom-themes-enable-bold t    ; if nil, bold is universally disabled
	  doom-themes-enable-italic t) ; if nil, italics is universally disabled
    (load-theme 'doom-palenight t))
#+end_src

** Modeline (doom-modeline)

#+begin_src emacs-lisp
  (use-package doom-modeline
    :custom
    (doom-modeline-project-detection 'projectile)
    (doom-modeline-buffer-file-name-style 'relative-to-project)
    (doom-modeline-workspace-name t)
    :init (doom-modeline-mode t))
#+end_src

** Icons

#+begin_src emacs-lisp
  (use-package all-the-icons
    :if (display-graphic-p))
#+end_src

** Enable colors in compilation buffer

#+begin_src emacs-lisp
  (use-package ansi-color
    :hook (compilation-filter . ansi-color-compilation-filter)) 
#+end_src

* Dashboard

#+begin_src emacs-lisp
  (use-package page-break-lines
  :config
    (page-break-lines-mode))

  (use-package dashboard
    :config
    (dashboard-setup-startup-hook))
  (setq initial-buffer-choice (lambda () (get-buffer-create "*dashboard*"))) ;; To display in client mode windows
  (setq dashboard-center-content t) ;; Center content in the window
  (setq dashboard-startup-banner 'logo)
  (setq dashboard-items '(
			  (projects  . 5) ;; Display 5 last projects
			  (recents   . 5) ;; Display 5 last opened files
			  (bookmarks . 5))) ;; Display 5 bookmarks
  (setq dashboard-set-heading-icons t) ;; Icons for sections
  (setq dashboard-set-file-icons t) ;; Icons for items
  (setq dashboard-set-init-info nil) ;; Disable package load time info

  ;; Function to open/reopen dashboard
  (defun open-dashboard ()
    "Jump to the dashboard buffer, if doesn't exists create one."
    (interactive)
    (switch-to-buffer dashboard-buffer-name)
    (dashboard-mode)
    (dashboard-insert-startupify-lists)
    (dashboard-refresh-buffer))
#+end_src

* Bindings

** Remap <escape> to exit prompts

#+begin_src emacs-lisp
  (global-set-key (kbd "<escape>") 'keyboard-escape-quit)
#+end_src

** General package for leader key bindings

#+begin_src emacs-lisp
  (use-package general
    :config
    (general-evil-setup t)
    (general-create-definer my/leader-keys
      :keymaps '(normal visual emacs)
      :prefix "SPC"
      :global-prefix "C-SPC")
    (my/leader-keys
      "d"      'dired
      "e"      'dired-jump
      "f"      'find-file
      "q"      'open-dashboard
      "RET"    'eshell))
#+end_src

** Evil mode for vim like key bindings

#+begin_src emacs-lisp
  (use-package evil
    :init
    (setq evil-vsplit-window-right t)
    (setq evil-split-window-below t)
    (setq evil-want-keybinding nil)
    (setq evil-want-C-u-scroll t)
    :config
    (evil-mode 1))

  (use-package evil-collection
    :after evil
    :config
    (evil-collection-init))
#+end_src

** Evil lion for text aligning

#+begin_src emacs-lisp
  (use-package evil-lion
    :hook
    (evil-mode . evil-lion-mode))
#+end_src

** Evil surround

#+begin_src emacs-lisp
  (use-package evil-surround
    :hook
    (evil-mode . evil-surround-mode))
#+end_src

** Evil commentary to comment blocks of code

#+begin_src emacs-lisp
  (use-package evil-commentary
    :hook
    (evil-mode . evil-commentary-mode))
#+end_src

* Configuration of built-in utilities

** Dired

#+begin_src emacs-lisp
  (use-package dired
    :ensure nil
    :commands
    (dired dired-jump)
    :custom
    ((dired-listing-switches "-agho --group-directories-first")))

  (use-package dired-single
    :defer t)

  (evil-collection-define-key 'normal 'dired-mode-map
    "h" 'dired-single-up-directory
    "l" 'dired-single-buffer)
#+end_src

** Eshell

#+begin_src emacs-lisp
  (use-package eshell-z
    :hook ((eshell-mode . (lambda () (require 'eshell-z)))
	   (eshell-z-change-dir .  (lambda () (eshell/pushd (eshell/pwd))))))

  (use-package eshell-syntax-highlighting
    :after esh-mode
    :config
    (eshell-syntax-highlighting-global-mode 1))
#+end_src

* Packages

** Utility

*** which-key

#+begin_src emacs-lisp
  (use-package which-key
    :init
    (setq which-key-popup-type 'minibuffer)
    (setq which-key-idle-delay 0.5)
    :config (which-key-mode))
#+end_src

*** Smartparens

#+begin_src emacs-lisp
  (use-package smartparens
    :config
    (require 'smartparens-config))
#+end_src

** Completion frameworks

*** Savehist to save search history

#+begin_src emacs-lisp
    (use-package savehist
      :config
      (setq history-length 25)
      (savehist-mode 1))
#+end_src

*** Orderless completion style

#+begin_src emacs-lisp
  (use-package orderless
    :init
    (setq completion-styles '(orderless)
	  completion-category-defaults nil
	  completion-category-overrides '((file (styles . (partial-completion))))))
#+end_src

*** Consult for completion in minibuffer

#+begin_src emacs-lisp
  (defun my/get-project-root ()
    (when (fboundp 'projectile-project-root)
      (projectile-project-root)))

  (use-package consult
    :bind (("C-s" . consult-line)
	   :map minibuffer-local-map
	   ("C-r" . consult-history))
    :custom
    (consult-project-root-function #'my/get-project-root)
    (completion-in-region-function #'consult-completion-in-region))
  (my/leader-keys
    "m" 'consult-man
    "b" 'consult-buffer
    "o" 'consult-file-externally)
#+end_src

*** Consult for completion at point

#+begin_src emacs-lisp
  (use-package corfu
    :bind (:map corfu-map
		("C-j" . corfu-next)
		("C-k" . corfu-previous))
    :hook (eshell-mode-hook . (lambda ()
				(setq-local corfu-auto nil)
				(corfu-mode)))
    :init
    (setq corfu-auto t
	  corfu-auto-prefix 2
	  corfu-quit-no-match 'separator
	  corfu-popupinfo-mode t
	  corfu-cycle t)
    (global-corfu-mode)
    (corfu-history-mode))

  (defun corfu-send-shell (&rest _)
    "Send completion candidate when inside comint/eshell."
    (cond
     ((and (derived-mode-p 'eshell-mode) (fboundp 'eshell-send-input))
      (eshell-send-input))
     ((and (derived-mode-p 'comint-mode)  (fboundp 'comint-send-input))
      (comint-send-input))))
  (advice-add #'corfu-insert :after #'corfu-send-shell)
#+end_src

*** Vertico for minibuffer completion

#+begin_src emacs-lisp
  (use-package vertico
    :init
    (vertico-mode)
    (setq vertico-cycle t)
    :bind (:map vertico-map
		("C-j" . vertico-next)
		("C-k" . vertico-previous)
		("C-f" . vertico-exit)))

  (use-package vertico-directory
    :after vertico
    :ensure nil
    :bind (:map vertico-map
		("DEL" . vertico-directory-up)
		("DEL" . vertico-directory-delete-char))
    :hook (rfn-eshadow-update-overlay . vertico-directory-tidy))
#+end_src

*** Marginalia for better minibuffer annotations

#+begin_src emacs-lisp
  (use-package marginalia
    :bind (:map minibuffer-local-map
		("M-A" . marginalia-cycle))
    :custom
    (marginalia-annotators '(marginalia-annotators-heavy marginalia-annotators-light nil))
    :init
    (marginalia-mode))
#+end_src

** Programming

*** Eglot for lsp feature

#+begin_src emacs-lisp
  (use-package eglot
    :custom
    (eglot-autoshutdown t)
    :init
    (setq completion-category-defaults nil)
    :hook
    (typescript-mode . eglot-ensure))

  (use-package consult-eglot)
#+end_src

*** Flycheck for syntax checking on the fly

#+begin_src emacs-lisp
  (use-package flycheck
    :defer)
#+end_src

*** Languages

**** Typescript

#+begin_src emacs-lisp
(use-package typescript-mode
  :init
  (define-derived-mode typescript-tsx-mode typescript-mode "TSX")
  (add-to-list 'auto-mode-alist `(,(rx ".tsx" eos) . typescript-tsx-mode))
  :custom
  (typescript-indent-level 2))
#+end_src

*** Treesitter for better syntax highlighting

#+begin_src emacs-lisp
  (use-package tree-sitter
    :config
    ;; activate tree-sitter on any buffer containing code for which it has a parser available
    (global-tree-sitter-mode)
    ;; you can easily see the difference tree-sitter-hl-mode makes for python, ts or tsx
    ;; by switching on and off
    (add-hook 'tree-sitter-after-on-hook #'tree-sitter-hl-mode))

  (use-package tree-sitter-langs
    :after tree-sitter)
#+end_src

*** Projectile for projects management

#+begin_src emacs-lisp
  (use-package projectile
    :diminish (projectile-mode)
    :config (projectile-mode)
    :bind-keymap ("C-c p" . projectile-command-map))

  (use-package consult-projectile)

  (my/leader-keys
    "pp" 'consult-projectile-switch-project
    "pf" 'consult-projectile-find-file
    "pd" 'consult-projectile-find-dir
    "pb" 'consult-projectile-switch-to-buffer
    "pr" 'consult-projectile-recentf
    "pc" 'projectile-compile-project
    "pt" 'projectile-test-project
    "pe" 'projectile-dired)
#+end_src

*** Magit for better git workflow

#+begin_src emacs-lisp
  (use-package magit)
#+end_src

*** diff-hl for highlighting changes in gutter

#+begin_src emacs-lisp
  (use-package diff-hl
    :custom-face
    '(diff-hl-change ((t (:background (doom-color 'yellow))))) 
    '(diff-hl-insert ((t (:background (doom-color 'green))))) 
    '(diff-hl-delete ((t (:background (doom-color 'red))))) 
    :init
    (add-hook 'magit-pre-refresh-hook 'diff-hl-magit-pre-refresh)
    (add-hook 'magit-post-refresh-hook 'diff-hl-magit-post-refresh)
    :config
    (global-diff-hl-mode)
    (diff-hl-flydiff-mode)
    (diff-hl-dired-mode))
#+end_src

*** Ocaml specific config

#+begin_src emacs-lisp
  (let ((opam-share (ignore-errors (car (process-lines "opam" "var" "share")))))
    (when (and opam-share (file-directory-p opam-share))
      ;; Register Mcerlin
      (add-to-list 'load-path (expand-file-name "emacs/site-lisp" opam-share))
      (autoload 'merlin-mode "merlin" nil t nil)
      ;; Automatically start it in OCaml buffers
      (add-hook 'tuareg-mode-hook 'merlin-mode t)
      (add-hook 'caml-mode-hook 'merlin-mode t)
      ;; Use opam switch to lookup ocamlmerlin binary
      (setq merlin-command 'opam)))
#+end_src

** Misc

*** undo-tree

#+begin_src emacs-lisp
  (use-package undo-tree
    :ensure t
    :after evil
    :diminish
    :config
    (evil-set-undo-system 'undo-tree)
    (global-undo-tree-mode 1))
#+end_src

*** Helpful

#+begin_src emacs-lisp
  (use-package helpful
    :bind
    ("C-h f"   . helpful-callable)
    ("C-h v"   . helpful-variable)
    ("C-h h"   . helpful-key)
    ("C-h C-d" . helpful-at-point)
    ("C-h F"   . helpful-function)
    ("C-h C"   . helpful-command))
#+end_src

*** Ledger mode

#+begin_src emacs-lisp
  (use-package ledger-mode
    :init
    (setq ledger-clear-whole-transaction 1)
    :mode "\\.dat\\'")
#+end_src
